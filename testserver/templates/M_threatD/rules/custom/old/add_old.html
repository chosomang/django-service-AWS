{% load static %}
<link rel="stylesheet" href="{% static '/css/rule_ani.css' %}">
<div class="col-xl">
    <div class='p-2'>
        <h2 class="mb-3 font-weight-bold text-center text-teiren">{{cloud}} 사용자 설정 정책 추가</h2>
        <div class="card-body shadow" style="border-radius:20px;">
            <form id='new_rules' method='post'>
                <input type="hidden" name="count" id="count" value= />
                <input type="hidden" name="cloud" id="cloud" value='{{cloud}}' />
            </form>
            <div class='row justify-content-center'>
                <button type='button' onclick='addrules("{{cloud}}");return false' class='btn btn-md btn-outline-teiren mt-4 mr-3' >Static 정책</button>
                <button type='button' onclick='addrules("{{cloud}}");return false' class='btn btn-md btn-outline-teiren mt-4 mr-3' >Dynamic 정책</button>
            </div>
            <input type='button' value='정책 추가' class="btn btn-teiren btn-block mt-4" onclick='send("{{cloud}}")'>
        </div>
    </div>
</div>
<script>
    function addrules(cloud){
        var count = $('#new_rules').find('.rule').length+1
        if(count>1 && $('#new_rules').find('.flow_rule').length == 0){
            $.ajax({
                url: '/custom/add/flow/',
                headers:{
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'post'
            }).done(function(data){
                $('#new_rules').prepend(data)
                $('.flow_rule').slideDown('normal')
            })
        }
        $.ajax({
            url: '/custom/add/new/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type: 'post',
            data:{
                count: count,
                cloud: cloud
            }
        }).done(function(data){
            $('#new_rules').append(data)
            $('#rule_'+String(count)).slideDown('normal')
        })
    }
    function changerule(url, e, count, cloud){
        var content = $(e).parent()
        url = '/custom/add/'+url+'/'
        $.ajax({
            url: url,
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type:'post',
            data:{
                count:count,
                cloud:cloud
            }
        }).done(function(data){
            var del = $(e).parent().children()
            del.remove()
            content.append($(data).find('.content').children())
        })
    }
    function hide(e){
        var content = $(e).parent().parent().parent()
        $(content).find('.content').slideUp('normal', function () {$(this).hide()})
        var show = $(e).parent().find('.show')
        $(show).attr('hidden', false)
        $(e).attr('hidden', true)
    }
    function show(e){
        var content = $(e).parent().parent().parent()
        $(content).find('.content').slideDown('normal', function () {$(this).show()})
        var hide = $(e).parent().find('.hide')
        $(hide).attr('hidden', false)
        $(e).attr('hidden', true)
    }
    
    function new_count(){
        var rules = $('#new_rules').find('.rule')
        for(var i=0; i<rules.length; i++){
            var input = $(rules[i]).find('input')
            for(var j=0; j<input.length; j++){
                input[j].name = input[j].name.slice(0,-1)+(i+1)
            }
            var select = $(rules[i]).find('select')
            for(var j=0; j<select.length; j++){
                select[j].name = select[j].name.slice(0,-1)+(i+1)
            }
            var number = $(rules[i]).find('.row h5')
            number.text((i+1)+'번 째 행위')
            rules[i].id = rules[i].id.slice(0,-1)+(i+1)
        }
    }
    function delrule(e){
        var rule = $(e).parent().parent().parent()
        $(rule).slideUp('normal', function() {$(this).remove();})
        var count = $('#new_rules').find('.rule').length-1
        if(count<2){
            $('.flow_rule').slideUp('normal', function(){$(this).remove();})
        }
        setTimeout(() => {
            new_count()
        }, 450)
    }
    function moveup(e){
        var id = $(e).parent().parent().parent()[0].id.slice(-1)
        if(id != '1'){
            var rule1 =  $(document).find('#rule_'+id)
            var rule2 = $(document).find('#rule_'+(Number(id)-1))
            var selected1 = $(rule1).find('select option:selected').val()
            var selected2 = $(rule2).find('select option:selected').val()
            var content1 = $(rule1).children().clone()
            var content2 = $(rule2).children().clone()
            var height1 = rule1.height()
            var height2 = rule2.height()
            document.documentElement.style.setProperty('--height1', height1+65+'px');
            document.documentElement.style.setProperty('--height2', (0-height2-65)+'px');
            $(rule1).addClass('moveup')
            $(rule2).addClass('movedown')
            setTimeout(() => {
                $(rule1).children().remove()
                $(rule2).children().remove()
                $(rule1).append(content2)
                $(rule2).append(content1)
                if(selected1 == '행위 선택' || selected1 == '로그 종류'){
                    $(rule2).find('select option').prop('selected', false)
                }
                else{
                    $(rule2).find('select option[value='+selected1+']').prop('selected', true)
                }
                if(selected2 == '행위 선택' || selected2 == '로그 종류'){
                    $(rule1).find('select option').prop('selected', false)
                }
                else{
                    $(rule1).find('select option[value='+selected2+']').prop('selected', true)
                }
                numbers()
                $(rule1).removeClass('moveup')
                $(rule2).removeClass('movedown')
            }, 1000);
        }
    }
    function movedown(e){
        var id = $(e).parent().parent().parent()[0].id.slice(-1)
        var count = $('#new_rules').find('.rule').length
        if(id != String(count)){
            var rule1 =  $(document).find('#rule_'+id)
            var rule2 = $(document).find('#rule_'+(Number(id)+1))
            var selected1 = $(rule1).find('select option:selected').val()
            var selected2 = $(rule2).find('select option:selected').val()
            var content1 = $(rule1).children().clone()
            var content2 = $(rule2).children().clone()
            var height1 = rule1.height()
            var height2 = rule2.height()
            document.documentElement.style.setProperty('--height1', height2+65+'px');
            document.documentElement.style.setProperty('--height2', (0-height1-65)+'px');
            $(rule2).addClass('moveup')
            $(rule1).addClass('movedown')
            setTimeout(() => {
                $(rule1).children().remove()
                $(rule2).children().remove()
                $(rule1).append(content2)
                $(rule2).append(content1)
                if(selected1 == '행위 선택' || selected1 == '로그 종류'){
                    $(rule2).find('select option').prop('selected', false)
                }
                else{
                    $(rule2).find('select option[value='+selected1+']').prop('selected', true)
                }
                if(selected2 == '행위 선택' || selected2 == '로그 종류'){
                    $(rule1).find('select option').prop('selected', false)
                }
                else{
                    $(rule1).find('select option[value='+selected2+']').prop('selected', true)
                }
                numbers()
                $(rule2).removeClass('moveup')
                $(rule1).removeClass('movedown')
            }, 1000);
        }
    }
    function numbers(){
        var rules = $(document).find('.rule')
        var count = rules.length
        for(var i=0; i<count; i++){
            $(rules[i]).attr('id', 'rule_'+(i+1))
            var name = $(rules[i]).find('h5').text((i+1)+'번 째 행위')
            var input = $(rules[i]).find('input')
            for(var j=0; j<input.length; j++){
                $(input[j]).attr('name', input[j].name.replace(/\d$/, (i+1)))
            }
            if($(rules[i]).find('select').length > 0){
                var select = $(rules[i]).find('select')
                for(var j=0; j<select.length; j++){
                    $(select[j]).attr('name', select[j].name.replace(/\d$/, (i+1)))
                }
            }
        }
    }
    function send(cloud){
        var count = $('#new_rules').find('.rule').length
        $('#count').val(count)
        var data = $('#new_rules').serialize()
        $.ajax({
            url:'/custom/add/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: data,
            type:'post'
        }).done(function(data){
            alert(data)
            console.log(data)
            if(data == '정책 추가 완료'){
                window.location.reload()
            }
        })
    }
    function add_property(count, cloud){
        var property_count = $('#properties_'+count).find('.property').length+1
        $.ajax({
            url:'/custom/add/property/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type: 'post',
            data:{
                count: count,
                property_count: property_count,
                cloud: cloud
            }
        }).done(function(data){
            $('#properties_'+count).append(data)
            $('#properties_'+count).find('#property'+property_count).slideDown('normal')
        })
    }
</script>