{% if normal %}
<div class="col-xl">
    <div class="mb-4">
        <div class="text-center">
            <h2 class="mb-3 font-weight-bold text-center text-teiren">{{normal.ruleName}} 수정</h2>
            <input type='hidden' id='type' value="{{normal.request.log_type}}">
        </div>
        <div class="card-body shadow" style="border-radius:20px;">
            <form id='edit_form'>
                <div class="form-group text-center">
                    <div class="text-center mt-3">
                        <div class="col-8 mb-1" style='margin: 0 auto'>
                            <label class="d-block" for="productName">Log Type</span>
                            <select class="btn btn-md btn-block" style="background-color:#FFFFFF; border-color:#E5E5E5" name="eventSource" id="eventSource">
                                <option>{{normal.request.log_type}}</option>
                                {% for type in types %}
                                <option value="{{type}}">{{type}}</option>
                                {% endfor %}
                            </select> &nbsp;
                        </div>
                    </div>
                </div>
                <div class="form-group row text-center">
                    <div class="col-sm-6 mb-sm-1">
                        <span>Rule 이름</span>
                        <input type="text-area" class="form-control form-control-user" name="ruleName" value="{{normal.ruleName}}" placeholder="Rule 이름">
                    </div>
                    <div class="col-sm-6">
                        <span>Rule 설명</span>
                        <input type="text-area" class="form-control form-control-user" name="ruleComment" value="{{normal.ruleComment}}" placeholder="Rule 설명">
                    </div>
                </div>
                <div class="form-group text-center">
                    <div class="col-6" style="margin: 0 auto;">
                        <span class='pr-3'>Rule 위협 영향</span>
                        <select id ="level" name='level' class="btn btn-md property" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                            <option value="{{normal.level}}">{{normal.level}}</option>
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                        </select>
                    </div>
                </div>
                <div id="properties">
                {% for property in normal.properties %}
                    <div id="property_div_{{forloop.counter}}" class="form-group row text-center">
                        <div class="text-center col-6 mb-1">
                            <span class='pr-3'>정책 특성 {{forloop.counter}}</span>
                            <br>
                            <select id ="property{{forloop.counter}}" name='property{{forloop.counter}}' class="btn btn-md property" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                                <option value="{{property.key}}">{{property.key}}</option>
                                <option>새로운 정책 특성</option>
                                {% for log_property in normal.log_properties %}
                                <option value={{log_property}}>{{log_property}}</option>
                                {% endfor%}
                            </select>
                        </div>
                        <div class="col-6">
                            <span>정책 특성 값 {{forloop.counter}}</span>
                            <input type="text-area" class="form-control form-control-user" name="property_val{{forloop.counter}}" value="{{property.value}}">
                        </div>
                    </div>
                    <script>
                        $(function(){
                            $('#property{{forloop.counter}}').on("change", function(){
                                if($(this).val() === '새로운 정책 특성'){
                                    $('#property_div_{{forloop.counter}}').append(`
                                    <div id="property_key{{forloop.counter}}"  class="col-6">
                                        <span>새로운 정책 특성 {{forloop.counter}}</span>
                                        <input type="text-area" class="form-control form-control-user" name="property_key{{forloop.counter}}" placeholder="새로운 정책 특성 {{forloop.counter}}">
                                    </div>
                                    `)
                                }
                                else{
                                    if($('#property_key{{forloop.counter}}').length > 0){
                                        $('#property_key{{forloop.counter}}').remove()
                                    }
                                }
                            })
                        })
                    </script>
                {% endfor %}
                </div>
                <div id='add_property' class="d-flex justify-content-center align-items-center mb-3">
                    <button type="button" class="btn btn-teiren btn-block" onclick="add_property('{{normal.request.cloud}}')" style="width:97%">정책 특성 추가</button>
                </div>
                <div>
                    <input type=hidden name="og_rule_name" value="{{normal.ruleName}}">
                    <input type=hidden name="rule_id" value="{{normal.request.rule_id}}">
                    <input type=hidden name="on_off" value="{{normal.on_off}}">
                    <input type=hidden name="cloud" value="{{normal.request.cloud}}">
                    <input type=hidden name="is_flow" value='0'>
                    <input type="button" value="정책 수정" class="btn btn-teiren btn-block" onclick='edit_action()'>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function edit_action(event){
        var data = $('#edit_form').serialize()
        console.log(data)
        $.ajax({
            url: '/custom/edit/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: data,
            type: 'post'
        }).done(function(data){
            alert(data)
            if (data == '정책 수정 성공'){
                $('.modal').modal('hide')
                window.location.reload()
            }
        }).fail(function(data){
            alert('다시 시도해주세요')
        })
    }
    function add_property(cloud){
        var count = $('#properties').find('.property').length+1
        $.ajax({
            url:'/custom/edit/property/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type: 'post',
            data:{
                count: count,
                cloud: cloud
            }
        }).done(function(data){
            $('#properties').append(data)
            $('#properties').find('#property_div_'+count).slideDown('normal')
        })
    }
</script>
{% elif flow %}
<div class="col-xl">
    <div class="mb-4">
        <div class="text-center">
            <h2 class="m-0 font-weight-bold text-center text-teiren">{{flow.ruleName}} 수정</h2>
        </div>
        <div class="card-body shadow mt-3" style="border-radius:20px;">
            <form id="flow_edit_form">
                <div class="form-group row text-center">
                    <div class="col-sm-6 mb-sm-1">
                        <span>흐름 Rule 이름</span>
                        <input type="text-area" class="form-control form-control-user" name="ruleName" value="{{flow.ruleName}}" placeholder="흐름 Rule 이름">
                    </div>
                    <div class="col-sm-6">
                        <span>흐름 Rule 설명</span>
                        <input type="text-area" class="form-control form-control-user" name="ruleComment" value="{{flow.ruleComment}}" placeholder="흐름 Rule 설명">
                    </div>
                </div>
                <div class="form-group row text-center">
                    <div class="col-6">
                        <span>기타 행위 허용 수</span>
                        <input type="text" class="form-control form-control-user" name="blank" value="{{flow.blank}}" placeholder="ex. 3">
                    </div>
                    <div class="col-6">
                        <span class='pr-3'>Rule 위협 영향</span>
                        <select id ="level" name='level' class="btn btn-md property" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                            <option value="{{flow.level}}">{{flow.level}}</option>
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                        </select>
                    </div>
                </div>
                <div id="origin_rule_action" class="form-group row text-center">
                    {% for key, value in flow.rule.items %}
                    <div class="col-6 mb-1">
                        <lable for="rule{{forloop.counter}}">{{forloop.counter}}번째 행위</label>
                            <select class="btn btn-md btn-block" style="background-color:#FFFFFF; border-color:#E5E5E5" id="rule{{forloop.counter}}" name="rule{{forloop.counter}}">
                                <option>{{value}}</option>
                                <option value="">행위 없음</option>
                                {% for action in actions %}
                                <option value="{{action}}">{{action}}</option>
                                {% endfor %}
                            </select> &nbsp;
                    </div>
                    {% endfor %}
                    <div id='add_rule_button' class="col-6 d-flex justify-content-center align-items-center">
                        <button type="button" class="btn btn-teiren btn-block" onclick="add_rule_action()">정책 행위 추가</button>
                    </div>
                </div>
                <div>
                    <input type=hidden name="og_rule_name" value="{{flow.ruleName}}">
                    {%for key, value in flow.rule.items %}
                    <input type=hidden name="og_rule{{forloop.counter}}" value="{{value}}">
                    {% endfor %}
                    <input type=hidden name="cloud" value="{{flow.request.cloud}}">
                    <input type=hidden name="rule_id" value="{{flow.request.rule_id}}">
                    <input type=hidden name="is_flow" value='1'>
                    <input type="button" value="흐름 기반 정책 수정" class="btn btn-teiren btn-block" onclick='edit_action()'>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function add_rule_action(e){
        var action_count = $('#origin_rule_action div select').length
        console.log(action_count)
        $.ajax({
            url: '/custom/edit/add_rule/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data:{
                count: action_count,
                cloud: '{{ flow.request.cloud }}'
            },
            type:'post'
        }).done(function(data){
            $('#add_rule_button').remove()
            $('#origin_rule_action').append(data)
        }).fail(function(error){
            alert(error)
        })
    }
    function edit_action(event){
        var data = $('#flow_edit_form').serialize()
        $.ajax({
            url: '/custom/edit/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: data,
            type: 'post'
        }).done(function(data){
            alert(data)
            if (data == '정책 수정 성공'){
                $('.modal').modal('hide')
                window.location.reload()
            }
        }).fail(function(data){
            alert('다시 시도해주세요')
        })
    }
</script>
{% endif %}