{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- Begin Page Content -->

    Name: <input name="name" type="text"><br><br>
    Comment: <input name="comment" type="text"><br><br>
    Author: <input name="author" type="text"><br><br>
    Relation Compliance<br><br>


    <label for="compliance">상위 카테고리 선택:</label>
    <select id="compliance" onchange="updateArticles()">
        <!-- 초기에는 아무것도 선택되지 않도록 빈 옵션 추가 -->
        <option value="none">선택하세요</option>
    </select>

    <label for="article_selected">하위 카테고리 선택:</label>
    <select id="article_selected">
        <!-- 초기에는 아무것도 선택되지 않도록 빈 옵션 추가 -->
        <option value="none">상위 카테고리를 선택하세요</option>
    </select>

    <br><br>
    <button type="button" class="btn btn-md btn-teiren" onclick="add_data()">저장</button>
<script>
    function add_data(){
        var name=document.querySelector('input[name="name"]');
        var comment=document.querySelector('input[name="comment"]');
        var author=document.querySelector('input[name="author"]');
        var compliance=$('#compliance').val();
        var article_selected=$('#article_selected').val();

        console.log(name.value);
        console.log('compliance: ', compliance);
        console.log('article_selected: ', article_selected);


        $.ajax({
            url: '/compliance/evidence/data_add/',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            type: 'POST',
            data: {
                'name': name.value,
                'comment': comment.value,
                'author': author.value,
                'compliance': compliance,
                'article_selected': article_selected
            },
            success: function(response){
                if(response.startsWith('\n<meta')){
                    location.reload()
                }
                if(response === 'success'){
                    alert('Saved Successfully')
                    window.location.href= '/compliance/evidence/data'
                }else if(response === 'already exist'){
                    alert('Name is already exist. Try Again') //중복된거면 카테고리 comment라도 수정할 건지 물어볼 수 있어야 되는데,,,
                }else if(response === 'NULL'){
                    alert('Name must be entered. Try Again')
                }
                else {
                    alert('Failed To Save. Please Try Again')
                }
            },
            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText); 
            }
        })
    }

    // 페이지 로드 시 초기화 함수 호출
     window.onload = function() {
        // 상위 카테고리를 서버에서 받아오는 함수 호출
        fetchCategories();
    }

    // 상위 카테고리를 서버에서 받아오는 함수
    function fetchCategories() {
        var compliance_selected = document.getElementById('compliance');
        //실제로 데이터 가져오는 곳.

        var compliance_list=[]

        $.ajax({
            url: '/compliance/evidence_get_compliance',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            type: 'POST',
            data: {},
            success: function (response) {
                var compliance_list = response['compliance_list'];
                
                for (var i = 0; i < compliance_list.length; i++) {
                    var compliance = compliance_list[i];
                    var optionElement = document.createElement('option');
                    optionElement.value = compliance;
                    //console.log(compliance);
                    optionElement.text = compliance;
                    compliance_selected.add(optionElement);
                }
            },
            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText); 
            }
        })

    }

    // 상위 카테고리가 변경될 때 호출되는 함수
    function updateArticles() {
        var compliance_selected = document.getElementById('compliance');
        var article_selected = document.getElementById('article_selected');
        fetchSubCategories()
    }

    // 하위 카테고리를 서버에서 받아오는 함수
    function fetchSubCategories() {
        var compliance_selected = document.getElementById('compliance');
        //console.log(compliance_selected.value)

        $.ajax({
            url: '/compliance/evidence/get_compliance_articles',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            type: 'POST',
            data: {
                "compliance_selected": compliance_selected.value // Send the selected value to the server
            },
            success: function (response) {
                console.log(response);
                var article_list = response['article_list'];
    
                article_selected.innerHTML = ""; // 이전에 추가된 항목들 지우기
                var optionElement = document.createElement('option');
                optionElement.value = ''; // 실제 전달되는 값은 no만
                optionElement.text = '선택 안함';

                article_selected.add(optionElement);
                // 받아온 카테고리를 드롭다운에 추가
                for (var i = 0; i < article_list.length; i++) {
                    var article = '['+article_list[i]['no']+'] '+article_list[i]['name'];
                    var optionElement = document.createElement('option');
                    optionElement.value = article_list[i]['no']; // 실제 전달되는 값은 no만
                    console.log(article);
                    optionElement.text = article;
                    article_selected.add(optionElement);
                }
            },
            error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
    }

</script>


{% endblock %}

