<div id='rule_0' class="rule card-body shadow mt-4" style= "border-radius:20px; display:none;">
    <input type="hidden" id="ruleClass" name="ruleClass" value="static"/>
    <div class='row'>
        <h5 class='text-teiren font-weight-bold ml-3 mt-2'>Static 정책 설정</h5>
        <div class="ml-auto">
            <button type="button" class="btn btn-md btn-danger" style="border-radius:40px" onclick="deleteSection(0)"><i class="fas fa-trash-can"></i></button>
        </div>
    </div>
    <div class="content">
        <div class="form-group row text-center">
            <div class="col-sm-6 mb-sm-1">
                <span>정책 이름</span>
                <input type="text-area" class="form-control form-control-user" name="ruleName" placeholder="정책 이름 설정">
            </div>
            <div class="col-sm-6">
                <span>정책 설명</span>
                <input type="text-area" class="form-control form-control-user" name="ruleComment" placeholder="정책 설명">
            </div>
        </div>
        <div class="d-flex justify-content-center text-center mb-2">
            <div style="width:30%">
                <span>정책 중요도</span>
                <br>
                <select id="ruleLevel" name="ruleLevel" class="btn btn-md" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                    <option value="1">1. LOW</option>
                    <option value="2">2. MID</option>
                    <option value="3">3. HIGH</option>
                    <option value="4">4. CRITICAL</option>
                </select>
            </div>
        </div>
        <div id="properties">
            <div id="property1" class="form-group row text-center prop">
                <div class="text-center col-4 mb-1">
                    <span>정책 속성 1</span>
                    <br>
                    <input type="text-area" class="form-control form-control-user" list="property_list_1" name="property_key_1" onchange="newPropertyKey(this)" placeholder="정책 속성 1">
                    <datalist id="property_list_1">
                        <option value='새로운 정책 속성'></option>
                        {% for property in log_properties %}
                        {% if property == "eventSource" %}
                        {% else %}
                        <option value={{property}}></option>
                        {% endif %}
                        {% endfor%}
                    </datalist>
                </div>
                <div class="col-2">
                    <select name="property_op_1" class="btn btn-md mt-3 pl-0" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                        <option>=</option>
                        <option><></option>
                        <option>CONTAINS</option>
                    </select>
                </div>
                <div class="col-5">
                    <span>정책 속성 값 1</span>
                    <input type="text-area" class="form-control form-control-user" name="property_val_1" placeholder="정책 속성 값 1">
                </div>
                <div class="col-1 d-flex align-items-center justify-content-center px-0">
                    <button type="button" class="btn btn-teiren btn-sm" style="border-radius:40px" onclick="addProperty('{{cloud}}')">+</button>
                </div>
            </div>
        </div>
        <div class="form-group row text-center">
            <div class="col-sm-6 mb-sm-1">
                <span>탐지 횟수</span>
                <input type="text-area" class="form-control form-control-user" name="ruleCount" placeholder="정책 탐지 횟수 지정 (횟수 이상일 때 탐지)">
            </div>
            <div class="col-sm-6">
                <span>탐지 시간 범위</span>
                <input type="text-area" class="form-control form-control-user" name="timeRange" placeholder="탐지 시간 범위 (초단위)">
            </div>
        </div>
    </div>
    <input id="addNewRuleSetbtn" type='button' value='정책 추가' class="btn btn-teiren btn-block mt-4" onclick='addNewRuleSet()'>
    <script>
        function addNewRuleSet(){
            $('#count').val($('#new_rules').find('.rule').length)
            var data = $('#new_rules').serialize()
            $.ajax({
                url: '/custom/add/',
                headers:{
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: data,
                type: 'post'
            }).done(function(response){
                alert(response)
                if(response == '정책 추가 완료'){
                    window.location.reload()
                }
            })
        }
        
        function addProperty(cloud){
            var count = $('#properties').find('.prop').length + 1
            $.ajax({
                url:'/custom/add/static_slot/',
                headers:{
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                type: 'post',
                data:{
                    count: count,
                    cloud: cloud
                }
            }).done(function(data){
                $('#properties').append(data)
                $('#properties').find('#property'+count).hide().slideDown('normal')
            })
        }
        
        function deleteProperty(e){
            var prop = $(e).parent().parent().parent()
            prop.slideUp('normal')
            setTimeout(function(){
                prop.remove()
                resetStaticNumbers('.prop')
            }, 300)
        }
    
        function resetStaticNumbers(e){
            for (var i=0; i<$(e).length; i++){
                $(e)[i].id = $(e)[i].id.slice(0,-1)+(i+1)
                var input = $($(e)[i]).find('input')
                input.each(function(){
                    if ($(this)[0].list){
                        var datalist = $(this)[0].list.id.slice(0,-1)+(i+1)
                        $(this)[0].list.id = datalist
                        $($(this)[0]).attr('list', datalist)
                    }
                    $($(this)[0]).attr('name', $(this)[0].name.slice(0,-1)+(i+1))
                    $($(this)[0]).attr('placeholder', $(this)[0].placeholder.slice(0,-1)+(i+1))
                    var span = $($(this)[0]).parent().children('span')[0]
                    span.innerText = span.innerText.slice(0,-1)+(i+1)
                })
            }
        }

        function newPropertyKey(e){
            var num = e.name.slice(-1)
            if(e.value == '새로운 정책 속성'){
                $("#properties").find("#property"+num).append(
                    `
                    <div id="property_key_custom_${num}" class="col-4">
                        <span>새로운 정책 속성</span>
                        <input type="text-area" class="form-control form-control-user" name="property_custom_${num}" placeholder="새로운 정책 속성">
                    </div>
                    `
                )
            } else {
                if($("#property_key_custom_"+num).length > 0){
                    $("#property_key_custom_"+num).remove()
                }
            }
        }
    </script>
</div>

