{% load custom_filter %}
{% if static %}
<div class="col-xl">
    <div class="mb-4">
        <div class="text-center">
            <h2 class="mb-3 font-weight-bold text-center text-teiren">{{static.ruleName}} 수정</h2>
            <input type='hidden' id='type' value="{{static.request.log_type}}">
        </div>
        <div class="card-body shadow" style="border-radius:20px;">
            <form id='edit_form'>
                <input type="hidden" name="ruleClass" value="static"/>
                <div class="content">
                    <div class="form-group row text-center">
                        <div class="col-sm-6 mb-sm-1">
                            <span>정책 이름</span>
                            <input type="text-area" class="form-control form-control-user" name="ruleName" value="{{static.ruleName}}" placeholder="정책 이름 설정">
                        </div>
                        <div class="col-sm-6">
                            <span>정책 설명</span>
                            <input type="text-area" class="form-control form-control-user" name="ruleComment" value="{{static.ruleComment}}" placeholder="정책 설명">
                        </div>
                    </div>
                    <div class="d-flex justify-content-center text-center mb-2">
                        <div style="width:30%">
                            <span>정책 중요도</span>
                            <br>
                            <select id="ruleLevel" name="ruleLevel" class="btn btn-md" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                                {% make_list '1. LOW' '2. MID' '3. HIGH' '4. CRITICAL' as level_list %}
                                {% for level in  level_list %}
                                    {% if forloop.counter != static.level %}
                                        <option value="{{forloop.counter}}">{{level}}</option>
                                    {% else %}
                                        <option value="{{static.level}}" selected>{{static.level}}. {{static.level_label}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div id="properties">
                        {% for property in static.properties %}
                        <div id="property{{forloop.counter}}" class="form-group text-center prop">
                            {% if forloop.counter != 1 %}
                            <div class="d-flex justify-content-center mb-2" style="margin-right:10%">
                                <select name="property_logical_{{forloop.counter0}}" class="btn btn-md mt-3" style="background-color:#e7faff; border-color:#E5E5E5; width:15%;">
                                    {% with forloop.counter0|add:"-1" as num %}
                                    {% with static.properties|list_item:num as prop %}
                                        <option value={{prop.ruleLogicals}} selected>
                                        {{prop.ruleLogicals}}
                                        </option>
                                        {% make_list 'AND' 'OR' as logical_list %}
                                        {% for logical in logical_list %}
                                            {% if logical != prop.ruleLogicals %}
                                                <option>{{logical}}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                    {% endwith %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="form-group row text-center">
                                <div class="text-center col-4 mb-1">
                                    <span>정책 속성 {{forloop.counter}}</span>
                                    <br>
                                    <input type="text-area" class="form-control form-control-user" list="property_list_{{forloop.counter}}" name="property_key_{{forloop.counter}}" 
                                        onchange="newPropertyKey(this)" value="{{property.ruleKeys}}" placeholder="정책 속성 {{forloop.counter}}">
                                    <datalist id="property_list_{{forloop.counter}}">
                                        <option value='새로운 정책 속성'></option>
                                        {% for property in log_properties %}
                                        {% if property == "eventSource" %}
                                        {% else %}
                                        <option value={{property}}></option>
                                        {% endif %}
                                        {% endfor%}
                                    </datalist>
                                </div>
                                <div class="col-2">
                                    <select name="property_op_{{forloop.counter}}" class="btn btn-md mt-3 pl-0" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                                        {% make_list '=' '<>' 'CONTAINS' as op_list %}
                                        {% for op in op_list %}
                                            {% if op != property.ruleOperators %}
                                                <option>{{op}}</option>
                                            {% else %}
                                                <option selected >{{property.ruleOperators}}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-5">
                                    <span>정책 속성 값 {{forloop.counter}}</span>
                                    <input type="text-area" class="form-control form-control-user" name="property_val_{{forloop.counter}}" value="{{property.ruleValues}}" placeholder="정책 속성 값 {{forloop.counter}}">
                                </div>
                                <div class="col-1 d-flex align-items-center justify-content-center px-0">
                                    <button type="button" class="btn btn-teiren btn-sm" style="border-radius:40px" onclick="addProperty('{{cloud}}')">+</button>
                                    {% if forloop.counter != 1 %}
                                    <button type="button" class="btn btn-danger btn-sm ml-2" style="border-radius:40px" onclick="deleteProperty(this)">-</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-group row text-center">
                        <div class="col-sm-6 mb-sm-1">
                            <span>탐지 횟수</span>
                            {% if static.ruleCount > 1 %}
                                <input type="text-area" class="form-control form-control-user" name="ruleCount" value="{{static.ruleCount}}" placeholder="정책 탐지 횟수 지정 (횟수 이상일 때 탐지)">
                            {% else %}
                                <input type="text-area" class="form-control form-control-user" name="ruleCount" placeholder="정책 탐지 횟수 지정 (횟수 이상일 때 탐지)">
                            {% endif %}                            
                        </div>
                        <div class="col-sm-6">
                            <span>탐지 시간 범위</span>
                            {% if static.timeRange > 1 %}
                            <input type="text-area" class="form-control form-control-user" name="timeRange" value="{{static.timeRange}}" placeholder="탐지 시간 범위 (초단위)">
                            {% else %}
                            <input type="text-area" class="form-control form-control-user" name="timeRange" placeholder="탐지 시간 범위 (초단위)">
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div>
                    <input type=hidden name="og_rule_name" value="{{static.ruleName}}">
                    <input type=hidden name="rule_id" value="{{rule_id}}">
                    <input type=hidden name="cloud" value="{{cloud}}">
                    <input type="button" value="정책 수정" class="btn btn-teiren btn-block" onclick='ruleEditAction()'>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function ruleEditAction(event){
        var data = $('#edit_form').serialize()
        $.ajax({
            url: '/threat/custom/edit/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: data,
            type: 'post'
        }).done(function(data){
            alert(data)
            if (data == '정책 추가 완료'){
                $('.modal').modal('hide')
                window.location.reload()
            }
        }).fail(function(data){
            alert('다시 시도해주세요')
        })
    }

    function addProperty(cloud){
        var count = $('#properties').find('.prop').length + 1
        $.ajax({
            url:'/custom/add/static_slot/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type: 'post',
            data:{
                count: count,
                cloud: cloud
            }
        }).done(function(data){
            $('#properties').append(data)
            $('#properties').find('#property'+count).hide().slideDown('normal')
        })
    }
    
    function deleteProperty(e){
        var prop = $(e).parent().parent().parent()
        prop.slideUp('normal')
        setTimeout(function(){
            prop.remove()
            resetStaticNumbers('.prop')
        }, 300)
    }

    function resetStaticNumbers(e){
        for (var i=0; i<$(e).length; i++){
            $(e)[i].id = $(e)[i].id.slice(0,-1)+(i+1)
            var input = $($(e)[i]).find('input')
            input.each(function(){
                if ($(this)[0].list){
                    var datalist = $(this)[0].list.id.slice(0,-1)+(i+1)
                    $(this)[0].list.id = datalist
                    $($(this)[0]).attr('list', datalist)
                }
                $($(this)[0]).attr('name', $(this)[0].name.slice(0,-1)+(i+1))
                $($(this)[0]).attr('placeholder', $(this)[0].placeholder.slice(0,-1)+(i+1))
                var span = $($(this)[0]).parent().children('span')[0]
                span.innerText = span.innerText.slice(0,-1)+(i+1)
            })
        }
    }

    function newPropertyKey(e){
        var num = e.name.slice(-1)
        if(e.value == '새로운 정책 속성'){
            $("#properties").find("#property"+num).append(
                `
                <div id="property_key_custom_${num}" class="col-4">
                    <span>새로운 정책 속성</span>
                    <input type="text-area" class="form-control form-control-user" name="property_custom_${num}" placeholder="새로운 정책 속성">
                </div>
                `
            )
        } else {
            if($("#property_key_custom_"+num).length > 0){
                $("#property_key_custom_"+num).remove()
            }
        }
    }
</script>
{% elif dynamic %}
<div class="col-xl">
    <div class="mb-4">
        <div class="text-center">
            <h2 class="m-0 font-weight-bold text-center text-teiren">{{dynamic.ruleName}} 수정</h2>
        </div>
        <div class="card-body shadow mt-3" style="border-radius:20px;">
            <form id="edit_form">
                <input type="hidden" name="ruleClass" value="dynamic"/>
                <div id="rule_0" class="rule">
                    <div class="card-body shadow mt-4" style= "border-radius:20px;">
                        <div class='row'>
                            <h5 class='text-teiren font-weight-bold ml-3 mt-2'>Dynamic 정책 설정</h5>
                        </div>
                        <input type="hidden" id="ruleClass" name="ruleClass" value="dynamic"/>
                        <input type="hidden" id="count" name="count"/>
                        <div class="content">
                            <div class="form-group row text-center">
                                <div class="col-sm-6 mb-sm-1">
                                    <span>정책 이름</span>
                                    <input type="text-area" class="form-control form-control-user" name="ruleName" value={{dynamic.ruleName}} placeholder="{{dynamic.ruleName}}">
                                </div>
                                <div class="col-sm-6">
                                    <span>정책 설명</span>
                                    <input type="text-area" class="form-control form-control-user" name="ruleComment" value={{dynamic.ruleComment}} placeholder="{{dynamic.ruleComment}}">
                                </div>
                            </div>
                            <div class="d-flex justify-content-center text-center mb-2">
                                <div class="col-6">
                                    <span>정책 중요도</span>
                                    <br>
                                    <select id="ruleLevel" name="ruleLevel" class="btn btn-md" style="background-color:#FFFFFF; border-color:#E5E5E5; width:100%;">
                                        {% make_list '1. LOW' '2. MID' '3. HIGH' '4. CRITICAL' as level_list %}
                                        {% for level in  level_list %}
                                            {% if forloop.counter != dynamic.level %}
                                                <option value="{{forloop.counter}}">{{level}}</option>
                                            {% else %}
                                                <option value="{{dynamic.level}}" selected>{{dynamic.level}}. {{dynamic.level_label}}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <span>탐지 시간 범위</span>
                                    <input type="text-area" class="form-control form-control-user" name="timeRange" value={{dynamic.timeRange}} placeholder="{{dynamic.timeRange}}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dynamic_rules">
                        {% for flow in dynamic.flows %}
                        <div id='rule_{{forloop.counter}}' class="rule card-body shadow mt-4" style= "border-radius:20px;">
                            <div class='row'>
                                <h5 class='text-teiren font-weight-bold ml-3 mt-2'>탐지 정책 {{forloop.counter}}</h5>
                                {% if forloop.counter > 1%}
                                <div class="ml-auto">
                                    <button type="button" class="btn btn-teiren btn-md slotbtn" style="border-radius:40px" onclick="addDynamicSlot()">+</button>
                                    {% if forloop.counter > 2%}
                                    <button type="button" class="btn btn-danger btn-md slotbtn" style="border-radius:40px" onclick="deleteDynamicSlot(this)">-</button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="dynamic_content">
                                <div class="form-group row text-center">
                                    <div class="col-6 mb-sm-1">
                                        <span>탐지 정책 이름</span>
                                        <input type="hidden" name="flow_og_{{forloop.counter}}_1" value="{{flow.flowName}}" />
                                        <input type="text-area" class="form-control form-control-user" name="flow_name_{{forloop.counter}}_1" value={{flow.flowName}} placeholder="{{flow.flowName}}">
                                    </div>
                                    <div class="col-6">
                                        <span>탐지 정책 설명</span>
                                        <input type="text-area" class="form-control form-control-user" name="flow_comment_{{forloop.counter}}_1" value={{flow.flowComment}} placeholder="{{flow.flowComment}}">
                                    </div>
                                </div>
                                <div class="properties">
                                    {% with forloop.counter as flow_num %}
                                    {% for key in flow.keys %}
                                    {% with flow.values|list_item:forloop.counter0 as value %}
                                    <div id="flow{{flow_num}}_1" class="form-group row text-center prop">
                                        <div class="text-center col-6 mb-1">
                                            <span>탐지 정책 속성</span>
                                            <br>
                                            <input type="text-area" class="form-control form-control-user" list="flow_list_{{flow_num}}_{{forloop.counter}}" name="flow_key_{{flow_num}}_{{forloop.counter}}" onchange="newPropertyKey(this)" value="{{key}}" placeholder="{{key}}">
                                            <datalist id="flow_list_{{flow_num}}_{{forloop.counter}}">
                                                <option value='탐지 정책 속성'></option>
                                                <option value='새로운 탐지 정책 속성'></option>
                                                {% for property in log_properties %}
                                                {% if property == "eventSource" %}
                                                {% else %}
                                                <option value={{property}}></option>
                                                {% endif %}
                                                {% endfor%}
                                            </datalist>
                                        </div>
                                        <div class="col-5">
                                            <span>탐지 정책 속성 값</span>
                                            <input type="text-area" class="form-control form-control-user" name="flow_val_{{flow_num}}_{{forloop.counter}}" value="{{value}}" placeholder="{{value}}">
                                        </div>
                                        <div class="col-1 d-flex align-items-center ml-auto">
                                            <button type="button" class="btn btn-teiren btn-sm ml-auto mr-auto" style="border-radius:40px" onclick="addDynamicProperty({{flow_num}})">+</button>
                                            {% if forloop.counter != 1 %}
                                            <button type="button" class="btn btn-danger btn-sm mr-auto" style="border-radius:40px" onclick="deleteDynamicProperty(this)">-</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                                <div class="col-12 d-flex justify-content-center text-center mt-3">
                                    <div class="col-6">
                                        <span>탐지 횟수</span>
                                        <input type="text-area" class="form-control form-control-user" name="flow_count_{{forloop.counter}}_1" placeholder="정책 탐지 횟수 지정 (횟수 이상일 때 탐지)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-block btn-teiren mt-3 slotbtn" onclick="dynamicFlow()">탐지 방식 수정</button>
                    <div id="dynamic_flow" class="card-body shadow mt-4" style= "border-radius:20px; display: none;">
                        <div class='row'>
                            <h5 class='text-teiren font-weight-bold ml-3 my-2'>Dynamic 탐지 방식</h5>
                            <div class="ml-auto">
                                <button type="button" class="btn btn-md btn-outline-teiren" style="border-radius:40px" onclick="dynamicRule()">정책 설정 돌아가기</button>
                            </div>
                        </div>
                        <div id="flow_content">
                        </div>
                        <button type="button" class="btn btn-block btn-teiren mt-3" onclick="addNewDynamicRule()">Dynamic 정책 추가</button>
                    </div>
                </div>
                <div>
                    <input type=hidden name="og_rule_name" value="{{dynamic.ruleName}}">
                    <input type=hidden name="cloud" value="{{cloud}}">
                    <input type=hidden name="rule_id" value="{{rule_id}}">
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function addNewDynamicRule(){
        $('#count').val($('.rule').length-1)
        var data = $('#edit_form').serialize()
        $.ajax({
            url: '/custom/edit/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: data,
            type: 'post'
        }).done(function(response){
            alert(response)
            if(response == '정책 추가 완료'){
                window.location.reload()
            }
        })
    }
    
    function addDynamicSlot(){
        var count = $('.rule').length
        $('#rule_'+count).remove()
        $.ajax({
            url:'/custom/add/dynamic_slot/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            type: 'post',
            data:{
                count: count,
                cloud: '{{cloud}}'
            }
        }).done(function(data){
            $('#dynamic_rules').append(data)
            $('#rule_'+count).slideDown('normal')
        })
    }

    function deleteDynamicSlot(e){
        var num = $(e).parent().parent().parent()[0].id.slice(-1)
        $('#rule_'+num).slideUp('normal')
        setTimeout(function(){
            $('#rule_'+num).remove()
            resetRuleNumbers(num)
        }, 300)
    }

    function addDynamicProperty(flow_num){
        var prop_num = $('#rule_'+flow_num).find('.prop').length + 1
        $.ajax({
            url:'/custom/add/dynamic_property_slot/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data:{
                cloud: '{{cloud}}',
                flow_num: flow_num,
                prop_num: prop_num
            },
            type: 'post'
        }).done(function(response){
            $('#flow'+flow_num+'_'+prop_num).remove()
            $('#rule_'+flow_num).find('.properties').append(response)
            $('#flow'+flow_num+'_'+prop_num).hide().slideDown('normal')
        })
    }

    function deleteDynamicProperty(e){
        var num = $(e).parent().parent().attr('id').slice(-3)
        var flow_num = num[0]
        var prop_num = Number(num[2])
        $('#flow'+flow_num+'_'+prop_num).slideUp('normal')
        setTimeout(function(){
            $('#flow'+flow_num+'_'+prop_num).remove()
            resetPropertyNumbers(flow_num)
        }, 500)
    }

    function dynamicFlow(){
        $.ajax({
            url: '/custom/add/flow_check/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                cloud: '{{cloud}}',
                rules: $('#dynamic_rules input').serialize(),
                rule_count: $('#dynamic_rules .rule').length,
                wheres: '{{dynamic.wheres|safe}}'
            },
            type: 'post'
        }).done(function(response){
            if(response.startsWith('error')){
                var error = response.slice(6)
                alert(error)
            }
            else{
                $('.slotbtn').fadeOut()
                $('.dynamic_content').slideUp('normal')
                $('#dynamic_flow').fadeIn()
                $('#flow_content').append(response)
            }
        }) 
    }

    function dynamicRule(){
        $('#dynamic_flow').fadeOut()
        $('.slotbtn').fadeIn()
        $('.dynamic_content').slideDown('normal')
        $('#flow_content').html('')
    }

    function addFlow(){
        var count = $('.flow').length+1
        $.ajax({
            url:'/custom/add/flow_slot/',
            headers:{
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                cloud: '{{cloud}}',
                rules: $('#dynamic_rules input').serialize(),
                rule_count: $('#dynamic_rules .rule').length,
                flow_count: count
            },
            type: 'post'
        }).done(function(response){
            $('#flow_content').append(response)
            $('#flow_'+count).hide().slideDown('normal')
        })
    }

    function deleteFlow(e){
        var num = $(e).parent().parent().parent()[0].id.slice(-1)
        $('#flow_'+num).slideUp('normal')
        setTimeout(function(){
            $('#flow_'+num).remove()
            resetFlowNumbers(num)
        }, 500)
    }

    function newPropertyKey(e){
        var num = e.name.slice(-3)
        if(e.value == '새로운 탐지 정책 속성'){
            $(".properties").find("#flow"+num).append(
                `
                <div id="flow_key_custom_${num}" class="col-6 mt-1">
                    <span>새로운 정책 속성</span>
                    <input type="text-area" class="form-control form-control-user" name="flow_custom_${num}" placeholder="새로운 탐지 정책 속성">
                </div>
                `
            )
        } else {
            if($("#flow_key_custom_"+num).length > 0){
                $("#flow_key_custom_"+num).remove()
            }
        }
    }
    function resetPropertyNumbers(num){
        var prop = $('#rule_'+num).find('.prop')
        prop.each(function(i){
            this.id = `${this.id.slice(0,-3)}${num}_${i+1}`
            var input = $(this).find('input')
            input.each(function(){
                this.name = `${this.name.slice(0,-3)}${num}_${i+1}`
                if (this.list){
                    this.list.id = `${this.list.id.slice(0,-3)}${num}_${i+1}`
                    $(this).attr('list', `${$(this).attr('list').slice(0,-3)}${num}_${i+1}`)
                }
            })
        })
    }

    function resetRuleNumbers(num){
        var rule = $('.rule')
        rule.each(function(i){
            if (i == 0){ return true }
            this.id = `${this.id.slice(0,-1)}${i}`
            $(this).find('.row h5').text(`탐지 정책 ${i}`)
            var input = $(this).find('input').slice(0,2)
            input.each(function(){
                this.name = `${this.name.slice(0,-3)}${i}_1`
            })
            resetPropertyNumbers(i)
        })
    }

    function resetFlowNumbers(num){
        var flow = $('.flow')
        flow.each(function(i){
            this.id = `${this.id.slice(0,-1)}${i+1}`
            $(this).find('.row h6').text(`탐지 ${i+1}`)
            var select = $(this).find('select')
            select.each(function(){
                if (this.name.includes('logical')){
                    this.name = `${this.name.slice(0,-1)}${i}`
                }
                else{ this.name = `${this.name.slice(0,-1)}${i+1}` }
            })
            var input = $(this).find('input')
            input.each(function(){
                this.name = `${this.name.slice(0,-1)}${i+1}`
                if (this.list){
                    this.list.id = `${this.list.id.slice(0,-1)}${i+1}`
                    $(this).attr('list', `${$(this).attr('list').slice(0,-1)}${i+1}`)
                }
            })
        })
    }
</script>
{% endif %}