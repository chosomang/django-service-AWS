{% extends 'base.html' %}
{% load static %}
{% block head %}
<!-- Page Essential -->
<link rel="stylesheet" href="{% static '/css/tab_table.css' %}">
<link rel="stylesheet" href="{% static '/M_threatD/css/searchcard.css' %}">
{% endblock %}
{% block content %}
<div class="locationbar ml-2">
    <span>Threat Management &nbsp;&nbsp;>&nbsp;&nbsp;Rule configuration &nbsp;&nbsp;>&nbsp;&nbsp;{{resourceType|title}} Rules &nbsp;&nbsp;>&nbsp;&nbsp;</span>
    <span class="current">{{logType}} Rules<span>
</div>
<div>
    <div>
        <h6 class="h3 mb-2 font-weight-bold text-gray-800 ml-2">{{logType}} Rules</h6>
        <p class="h6 mb-4 ml-2">Configure {{logType}} Rule Sets In Detail</p>
    </div>
    {% include "./searchcard.html" %}
    <div class="tabs">
        <input type="radio" id="modal-tab1" name="tab-control-modal" checked>
        <input type="radio" id="modal-tab2" name="tab-control-modal">
        <ul class='ul'>
            <li title="Custom Rule">
                <label for="modal-tab1" role="button">
                    <span>Custom Rule</span>
                </label>
            </li>
            <li title="Default Rule">
                <label for="modal-tab2" role="button">
                    <span>Default Rule</span>
                </label>
            </li>
        </ul>
        <div class="slider">
            <div class="indicator"></div>
        </div>
        <div class="content">
            <section>
                {% include './custom.html' %}
            </section>
            <section>
                {% include './default.html' %}
            </section>
        </div>
    </div>
</div>
<!-- Modal -->
<!-- Rule Detail Modal -->
<div class="modal fade card-body" id="detail-modal" role="dialog" style='overflow-y:auto' aria-labelledby="detailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content p-1" style='width:1000px; height:auto'>
            <div class='d-flex justify-content-end p-3'>
                <button type="button" class=close data-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body justify-content-center" id='detail_body'>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-md btn-teiren" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Add Modal -->
<div class="modal fade card-body" id="rule-modal" role="dialog" style='overflow-y:auto' aria-labelledby="detailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content p-1" style='width:1000px; height:auto'>
            <div class='d-flex justify-content-end p-3'>
                <button type="button" class=close data-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body justify-content-center" id='rule_body'>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-md btn-teiren" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Edit Modal -->
<div class="modal hide fade card-body" id="edit" role="dialog" style='overflow-y:auto' aria-labelledby="detailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content p-1" style='width:1000px; height:auto'>
            <button type="button" class="btn btn-teiren btn-md text-center mt-3 mr-3" style='margin-left:auto'
                data-dismiss='modal' data-toggle='modal' data-target='#detail-modal' onclick="$('#edit_body').html(''); setTimeout(function(){$('#edit_message').show();},500)">
                <span class="icon text-white-50"><i class='fas fa-arrow-left'></i></span>
            </button>
            <div class="modal-body card-body">
                <div class="align-items-center flex-column text-teiren px-5" id="edit_message" style="display:flex;">
                    <h5>Detected Alerts Will Be Deleted If Edited</h5>
                    <h5>We Suggest You To Turn Off The Corresponding Rule</h5>
                    <br>
                    <h5 class="text-danger">Will You Still Edit?</h5>
                    <div class="ml-auto">
                        <button class="btn btn-outline-teiren btn-md" onclick="editRuleModal()">Edit</button>
                        <button class="btn btn-outline-danger btn-md" data-dismiss='modal' data-toggle='modal' data-target='#detail-modal'>Cancel</button>
                    </div>
                </div>
                <div id="edit_body"></div>
            </div>
            <div class="modal-footer" id="modal_footer">
                <input type='button' class="btn btn-md btn-teiren" value="Close" data-dismiss='modal'>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal -->
<div class="modal hide fade card-body" id="del" role="dialog" style='overflow-y:auto' aria-labelledby="detailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content p-1" style='width:1000px; height:auto; border-color:red'>
            <div class="modal-body card-body" id='del_body'>
                <h4 class="text-center text-danger font-weight-bold"><span class='h3 text-center text-danger font-weight-bold p-3' id='rule_name'></span><br>정책을 삭제하시겠습니까?</h4>
            </div>
            <div class="modal-footer" id="modal_footer">
                <form>
                    <div id='del_form' method='post'></div>
                    <input type='button' class="btn btn-md btn-outline-teiren" value="Delete" onclick='deleteRuleAction(this.parentNode)'>
                    <input type='button' class="btn btn-md btn-outline-danger" value="Cancel" data-dismiss='modal' data-toggle='modal' data-target='#detail-modal'>
                </form>
            </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script src="{% static '/M_threatD/js/rule.js' %}"></script>
<script src="{% static '/M_threatD/js/addRule/ruleSection.js' %}"></script>
<script>
    //체크박스 전체선택
    function selectAll(selectAll, type) {
        $('input.'+type).each(function(){
            if ($(this).val() == 'regex'){
                this.checked = false
                $(`#${type}_regex`).slideUp('fast')
                $(`#${type}_regex input`).val('')
                return 1
            }
            this.checked = selectAll.checked
        })
    }

    //체크박스 전체선택 해제
    function selectcheck(e, type){
        if(e.checked == false){
            $('input[name='+type+'_all]')[0].checked = e.checked
            $(`#${type}_regex`).slideUp('fast')
            $(`#${type}_regex input`).val('')
        }
        else if($(e).val()=='regex'){
            $('input.'+type).each(function(){
                if(this == e){
                    return 1
                }
                this.checked = false
            })
            $(e).parent().parent().parent().parent().find('.search-dropdown-menu').hide()
            $(`#${type}_regex`).slideDown('fast')
            $(`#${type}_regex`).focus()
        }
        else{
            var count = 0
            $(`#${type}_regex`).slideUp('fast')
            $(`#${type}_regex input`).val('')
            $('input.'+type).each(function(){
                if($(this).val()== 'regex'){
                    this.checked = false
                }
                if(this.checked == true){
                    if(($(this).val()== 'regex')){
                        return 1
                    }
                    count += 1 
                }
            })
            if( count ==  $('input.'+type).length - 1 ){
                $('input[name='+type+'_all]')[0].checked = true
            }
        }
    }
    /// 체크박스 자동 표시/숨김
    $('.searchbox-input').on('focus', function(){
        $(this).parent().find('.search-dropdown-menu').slideDown('fast')
    })

    $('.searchbox-input').on('blur', function(){
        var dropdown = $(this).parent().find('.search-dropdown-menu')
        var this_var = this
        setTimeout(function() {
            if (!$('.dropdown-item:hover').length){
                if (!$(':checkbox:focus').length){
                    dropdown.slideUp('fast');
                }
            }else{
                this_var.focus()
            }
        }, 10);
    })
    $(':checkbox').on('blur', function(e) {
        var dropdown = $(this).parent().parent().parent().parent().find('.search-dropdown-menu')
        var this_var = this
        setTimeout(function() {
            if (!$('.dropdown-item:hover').length){
                if (!$(':checkbox:focus').length){
                    dropdown.slideUp('fast');
                }
            }else{
                this_var.focus()
            }
        }, 10);
    });

    $('.searchbox-input').on('input', function() {
        var input = $(this).val();

        // Iterate over each checkbox
        $(this).parent().find('.search-dropdown-menu li input[type="checkbox"]').each(function() {
            var checkboxValue = $(this);
            // If the checkbox value doesn't contain the input string, hide it
            if (!new RegExp(input, 'i').test(checkboxValue.val())) {
                $(this).parent().parent().hide();
            } else {
                $(this).parent().parent().show();
            }
        });
    });


    /// Search_Filter
    function searchFilter(e){
        var custom_rules = ''
        var default_rules = ''
        $.ajax({
            url: 'custom/filter/',
            headers:{
                'X-CSRFToken': "{{csrf_token}}"
            },
            data:$('#search').serializeArray(),
            type: 'post'
        }).done(function(response){
            custom_rules = response
        })
        $.ajax({
            url: 'default/filter/',
            headers:{
                'X-CSRFToken': "{{csrf_token}}"
            },
            data:$('#search').serializeArray(),
            type: 'post'
        }).done(function(response){
            default_rules = response
        })
        $("#dataTable_default").fadeOut()
        $("#dataTable_custom").fadeOut()
        setTimeout(function(){
            updateRules(default_rules, custom_rules)
        }, 300)
    }

    function updateRules(default_rules, custom_rules){
        $("#dataTable_custom").DataTable().destroy();
        $("#dataTable_default").DataTable().destroy();
        $('#dataTable_custom').html(custom_rules)
        $('#dataTable_default').html(default_rules)
        
        $("#dataTable_custom").DataTable({
            //데이터 테이블 0번째 인덱스부터 거꾸로 정렬(최신순 정렬)
            order: [
                [0, 'asc']
            ],
            columnDefs: [{
                targets: 4,
                type: 'threat-level'
            },
            {
                targets: 5,
                type: 'threat-on-off'
            }],
            ordering: true,
            // 표시 건수기능 숨기기
            lengthChange: false,
            // 검색 기능 숨기기
            searching: false,
        });
        $("#dataTable_default").DataTable({
            //데이터 테이블 0번째 인덱스부터 거꾸로 정렬(최신순 정렬)
            order: [
                [0, 'asc']
            ],
            columnDefs: [{
                targets: 4,
                type: 'threat-level'
            },
            {
                targets: 5,
                type: 'threat-on-off'
            }],
            ordering: true,
            // 표시 건수기능 숨기기
            lengthChange: false,
            // 검색 기능 숨기기
            searching: false,
        });
        $("#dataTable_default").fadeIn()
        $("#dataTable_custom").fadeIn()
    }


    $('.btn-collapse').on('click', function(){
        var chevron = $($(this).find('.material-symbols-outlined')[0])
        if ($.trim(chevron.text()) == 'expand_more'){
            chevron.text('expand_less')
            $('.searchcard-collapse').fadeIn()
            $('.collapsecard').slideDown()
        } else {
            chevron.text('expand_more')
            $('.collapsecard').slideUp()
            $('.searchcard-collapse').fadeOut()
        }
    })

    $('.btn-reset').hover(
        function(){
            $('.btn-reset .material-symbols-outlined').toggleClass('fa-spin fa-spin-reverse')
        },
        function(){
            $('.btn-reset .material-symbols-outlined').toggleClass('fa-spin fa-spin-reverse')
        }
    )

    $('.btn-info').hover(
        function(){
            $('.btn-info .material-symbols-outlined').toggleClass('fa-bounce')
        },
        function(){
            $('.btn-info .material-symbols-outlined').toggleClass('fa-bounce')
        }
    )
</script>
{% endblock %}