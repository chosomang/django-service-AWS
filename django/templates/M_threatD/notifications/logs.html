{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    .color-box{
        font-weight:900;
        padding: 0.4rem;        
        border-radius: 5px;
    }
    
    .color-box-danger{
        color: #e74a3b;
        background-color: rgba(231, 74, 59, 0.3);
    }

    .color-box-caution{
        color: #fd7e14;
        background-color: rgba(253, 126, 20, 0.3);
    }

    .color-box-warning{
        color: #ffb700;
        background-color: rgba(255, 212, 101, 0.3);
    }

    .color-box-success{
        color: #1ed45e;
        background-color: rgba(30, 212, 94, 0.3);
    }
</style>
<div class="container-fluid">
    <!-- Page Heading -->
    <h6 class="h5 mb-2 text-gray-800 ml-2 font-weight-bold">중요 위협 로그 확인하기</h6>
    <p class="ml-2 mb-4">중요 위협 로그들을 확인할 수 있습니다. </p>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-teiren">중요 위협 로그 목록</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive" style="overflow:hidden;">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0"
                    style="text-align:center;overflow:scroll;">
                    <thead>
                        <tr>
                            <th>확인여부</th>
                            <th>클라우드</th>
                            <th>행위 시간</th>
                            <th>탐지 정책</th>
                            <th>탐지 행위</th>
                            <th>위협 중요도</th>
                            <th>sourceIp</th>
                            <th>탐지 정책 번호</th>
                            <th>상세보기</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>확인여부</th>
                            <th>클라우드</th>
                            <th>행위 시간</th>
                            <th>탐지 정책</th>
                            <th>탐지 행위</th>
                            <th>위협 중요도</th>
                            <th>sourceIp</th>
                            <th>탐지 정책 번호</th>
                            <th>상세보기</th>
                        </tr>
                    </tfoot>
                    <tbody>
                        {% if data %}
                        {% for result in data %}
                        {% if 'alert' in result %}
                        <tr class="text-danger">
                            <td style="font-weight:900" width="200"><i class="fa-solid fa-eye-slash fa-bounce"></i></td>
                        {% else %}
                        <tr>
                            <td class="text-teiren" style="font-weight:900" width="200"><i class="fa-solid fa-circle-check"></i></td>
                        {% endif %}
                            {% for key, value in result.items %}
                            {% if key != 'form' %}
                            {% if key == 'detectedAction' %}
                            <td align="left" width="1000">{{value}}</td>
                            {% elif key == 'eventTime_format' or key == 'actionDisplayName' %}
                            <td width="200">{{value}}</td>
                            {% elif key == 'cloud'%}
                            <td width="200">{{value}}</td>
                            {% elif key == 'level'%}
                            <td width="180">
                                <div class="color-box color-box-{{value.1}}">{{value.0}}</div>
                            </td>
                            {% elif key == 'alert' %}
                            {% else %}
                            <td>{{value}}</td>  
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                            <td width="400">
                                <form method="POST" action="/threat/notifications/details/">
                                    {% csrf_token %}
                                    {% for key, value in result.form.items %}
                                    <input type="hidden" name="{{key}}" value="{{value}}">
                                    {% endfor %}
                                    {% if 'alert' in result %}
                                    <button class="btn btn-md btn-danger ">관련 로그</button>
                                    {% else %}
                                    <button class="btn btn-md btn-teiren ">관련 로그</button>
                                    {% endif %}
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script type="text/javascript">
    $.fn.dataTable.ext.type.order['threat-level-pre'] = function(data) {
        switch(data) {
            case '<div class="color-box color-box-danger">CRITICAL</div>':
                return 1;
            case '<div class="color-box color-box-caution">HIGH</div>':
                return 2;
            case '<div class="color-box color-box-warning">MID</div>':
                return 3;
            case '<div class="color-box color-box-success">LOW</div>':
                return 4;
            default:
                return 5;
        }
    };
    $.fn.dataTable.ext.type.order['alert-check-pre'] = function(data) {
        switch(data) {
            case '<i class="fa-solid fa-eye-slash fa-bounce"></i>':
                return 1;
            case '<i class="fa-solid fa-circle-check"></i>':
                return 2;
            default:
                return 3;
        }
    };
    $("#dataTable").DataTable({
        //데이터 테이블 0번째 인덱스부터 거꾸로 정렬(최신순 정렬)
        order: [
            [0, 'asc']
        ],
        columnDefs: [{
            targets:0,
            type: 'alert-check'
        },{
            targets: 5,
            type: 'threat-level'
        }],
        ordering: true,
    });
    $(function() {
        $('#threat_top').addClass('show')
        $(window).on("pageshow", function(event) {
            if (event.originalEvent.persisted) {
                location.reload();
            }
        });
    })
</script>
{% endblock %}