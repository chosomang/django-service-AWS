{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <h6 class="h3 mb-2 ml-2 font-weight-bold text-gray-800">Integrate Amazon Web Service Logs</h6>
    <p class="h6 mb-4 ml-2">Integrate AWS Logs To Teiren Cloud</p>
    <!-- Begin Page Content -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div style="float: left">
                <h6 class="m-0 font-weight-bold text-warning">
                    Authenticate AWS Account
                </h6>
            </div>
        </div>
        <div class="card-body" style="font-size:12px">
            <div class="table-responsive" style="overflow:hidden;">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0" style="table-layout:fixed;text-align:center;">
                    <tbody>
                        <form method="POST" id='account_form'>
                            <div class="form-group text-warning">ACCESS KEY
                                <div class="form-group text-dark">
                                    <input type='text' class="form-control" id="access_key" name="access_key" placeholder="ACCESS KEY">
                                </div>
                            </div>
                            <div class="form-group text-warning">SECRET KEY
                                <input type="password" class="form-control" id='secret_key' name="secret_key" placeholder="SECRET KEY">
                                <input type="checkbox" class="text-dark" onclick="secretkey()">Show Secret Key
                            </div>
                            <div class="form-group text-warning">REGION NAME
                                <div class="form-group text-dark">
                                    <input type='text' class="form-control" name="region_name" placeholder="REGION NAME">
                                </div>
                            </div>
                            <div class="form-group text-warning">BUCKET NAME
                                <div class="form-group text-dark">
                                    <input type='text' class="form-control" name="bucket_name" placeholder="BUCKET NAME">
                                </div>
                            </div>
                            <input type="button" class="btn btn-outline-primary" id='form-check' value="Confirm AWS Account Information"/>
                        </form>
                        <p><input type='hidden' class='mt-3 btn btn btn-primary' id='insert' value='Register'/>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- End Page Content -->
</div>
<!-- Modal -->
<div class="modal hide fade card-body" id="modal" role="dialog" aria-labelledby="detailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style='width:auto; height:auto'>
            <div class="modal-header">
                <h5 class="m-0 font-weight-bold text-primary" id='modal_title'>Integrate AWS Logs</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">x</span>
                </button>
            </div>
            <div class="modal-body card-body" style="font-size:12px;">
                <div class="table-responsive" style="overflow:hidden;">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0" style="table-layout:fixed;text-align:center;">
                        <tbody>
                            <p>AWS Authentication</p>
                            <form method="POST" id='insertform'>
                                <p>ACCESS KEY: <input type="text" class="form-control" id='modal_access_key' name="modal_access_key" value='' readonly></p>
                                <p>SECRET KEY: <input type="text" class="form-control" id='modal_secret_key' name="modal_secret_key" value='' readonly></p>
                                <p>REGION NAME: <input type="text" class="form-control" id='modal_region_name' name="modal_region_name" value='' readonly></p>
                                <p>BUCKET NAME: <input type="text" class="form-control" id='modal_bucket_name' name="modal_bucket_name" value='' readonly></p>
                                <div id='modal_body'>
                                    <p class='text-danger'>Will You Integrate AWS Logs?</p>
                                </div>
                        </tbody>
                    </table>
                </div>
                <div id='success'></div>
            </div>
            <div class="modal-footer" id="modal_footer">
                <div id='insert_check'>
                    <input type='button' id='insert_deny' class="btn btn-md btn-outline-danger" data-dismiss='modal'value="Cancel (No)">
                    <input type='button' id='insert_accept' class="btn btn-md btn-outline-primary" value="Registrate (Yes)">
                </div>
                <input type='hidden' id='insert_complete' class="btn btn-md btn-outline-primary" value="Confirm">
            </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    function secretkey() {
        var x = document.getElementById("secret_key");
        if (x.type === "password") {
            x.type = "text";
        }
        else {
            x.type = "password";
        }
    };
    $('#form-check').on('click', function () {
        var data = $('#account_form').serialize()
        $.ajax({
            url: 'check/',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            data: data,
            type: 'post'
        }).done(function (data) {
            document.getElementById("form-check").className = data.class;
            document.getElementById("form-check").value = data.value;
            if (data.modal) {
                document.getElementById("insert").type = 'button';
                $('#insert').on('click', function (event) {
                    document.getElementById("modal_access_key").value = data.modal.access_key;
                    document.getElementById("modal_secret_key").value = data.modal.secret_key;
                    document.getElementById("modal_region_name").value = data.modal.region_name;
                    document.getElementById("modal_bucket_name").value = data.modal.bucket_name;
                    $('#modal').modal('show');
                });
            };
        })
    })
    $('#insert_accept').on('click', function (event) {
        var post = $('#insertform').serialize();
        $.ajax({
            url: 'insert/',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            data: post,
            type: 'post'
        }).done(function (data) {
            $("#success").html(data);
            document.getElementById('modal_body').remove();
            $("#modal_title").text('AWS Cloud 등록 성공');
            $('#insert_check').remove();
            document.getElementById('insert_complete').type = 'button';
        }).fail(function (data) {
            $("#success_id").text('존재하지 않거나, 유효하지 않는 정보입니다.');
        })
    });
    $('#insert_complete').on('click', function (event) {
        $('#modal').modal('hide');
        window.location = document.referrer;
    });
</script>
{% endblock %}